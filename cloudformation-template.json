{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Keboola Syrup Server",
    "Parameters": {
        "InstanceType": {
            "Description": "WebServer EC2 instance type",
            "Type": "String",
            "Default": "c3.xlarge",
            "AllowedValues": [ "t1.micro", "m1.small", "m1.medium", "m3.medium", "m3.large", "c3.large", "c3.xlarge", "m1.large", "m1.xlarge", "m3.xlarge", "m3.2xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "c1.medium", "c1.xlarge", "cc1.4xlarge", "cc2.8xlarge", "cg1.4xlarge", "hi1.4xlarge", "hs1.8xlarge"],
            "ConstraintDescription": "must be a valid EC2 instance type."
        },
        "SecurityGroupVpcId": {
            "Description": "Security group id in VPC",
            "Type": "String",
            "MinLength": 2,
            "MaxLength": 255,
            "Default": "sg-8f9c8aed"
        },
        "Zone": {
            "Description": "Run instance in zone A or B",
            "Type": "String",
            "Default": "A",
            "AllowedValues": ["A", "B"]
        },
        "PapertrailPort": {
            "Description": "Papertrail port number",
            "Type": "Number",
            "Default": 49730
        },
        "KeyName": {
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the web server",
            "Type": "String",
            "Default": "Martin",
            "MinLength": 2,
            "MaxLength": 255
        },
        "NewRelicLicenseKey": {
            "Description": "New Relic license key",
            "Type": "String",
            "MinLength": 2,
            "MaxLength": 255
        },
        "SendgridName": {
            "Description": "Sendgrid user name",
            "Default": "Keboola_Centrum",
            "Type": "String",
            "MinLength": 2,
            "MaxLength": 255
        },
        "SendgridPassword": {
            "Description": "Sendgrid password",
            "Type": "String",
            "MinLength": 2,
            "MaxLength": 255
        },
        "GithubToken": {
            "Description": "Github token",
            "Type": "String"
        },
        "GoodDataWriterEnableCron": {
            "Description": "Start gooddata-writer crons (clean, accept invitations)",
            "Type": "Number",
            "MinValue": 0,
            "MaxValue": 1,
            "Default": 0
        },
        "GoodDataWriterWorkersCount": {
            "Description": "gooddata-writer workers count",
            "Type": "Number",
            "MinValue": 0,
            "Default": 0
        },
        "QueueWorkersCount": {
            "Description": "syrup queue workers count",
            "Type": "Number",
            "MinValue": 0,
            "Default": 0
        },
        "OrchestratorWorkersCount": {
            "Description": "orchestrator workers count",
            "Type": "Number",
            "MinValue": 0,
            "Default": 0
        },
        "OrchestratorEnableScheduler": {
            "Description": "Enable orchestrator scheduler",
            "Type": "Number",
            "MinValue": 0,
            "MaxValue": 1,
            "Default": 0
        }
    },
    "Mappings": {
        "AWSInstanceType2Arch": {
            "t1.micro": {
                "Arch": "PV64"
            },
            "m1.small": {
                "Arch": "PV64"
            },
            "m1.medium": {
                "Arch": "PV64"
            },
            "m3.medium": {
                "Arch": "PV64"
            },
            "m3.large": {
                "Arch": "PV64"
            },
            "m1.large": {
                "Arch": "PV64"
            },
            "m1.xlarge": {
                "Arch": "PV64"
            },
            "m3.xlarge": {
                "Arch": "PV64"
            },
            "m3.2xlarge": {
                "Arch": "PV64"
            },
            "m2.xlarge": {
                "Arch": "PV64"
            },
            "m2.2xlarge": {
                "Arch": "PV64"
            },
            "m2.4xlarge": {
                "Arch": "PV64"
            },
            "c1.medium": {
                "Arch": "PV64"
            },
            "c1.xlarge": {
                "Arch": "PV64"
            },
            "c3.large": {
                "Arch": "PV64"
            },
            "c3.xlarge": {
                "Arch": "PV64"
            },
            "cc1.4xlarge": {
                "Arch": "CLU64"
            },
            "cc2.8xlarge": {
                "Arch": "CLU64"
            },
            "cg1.4xlarge": {
                "Arch": "GPU64"
            },
            "hi1.4xlarge": {
                "Arch": "PV64"
            },
            "hs1.8xlarge": {
                "Arch": "PV64"
            }
        },
        "AWSRegionArch2AMI": {
            "us-east-1": {
                "PV64": "ami-fb8e9292"
            }
        },
        "ZoneToSubnet": {
            "A": {
                "SubnetId": "subnet-22f1d956"
            },
            "B": {
                "SubnetId": "subnet-5ac4b172"
            }
        }
    },
    "Resources": {

        "CfnUser": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "root",
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Sid": "Stmt1329997232569xk",
                                    "Action": [
                                        "s3:GetObject"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": [
                                        "arn:aws:s3:::keboola-configs/certificates/*",
                                        "arn:aws:s3:::keboola-configs/deploy-keys/*",
                                        "arn:aws:s3:::keboola-configs/syrup/*",
                                        "arn:aws:s3:::keboola-configs/transformation/*"
                                    ]
                                },
                                {
                                    "Sid": "UpdateSyrupConfigs",
                                    "Action": [
                                        "s3:PutObject"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": [
                                        "arn:aws:s3:::keboola-configs/syrup/*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },


        "HostKeys": {
            "Type": "AWS::IAM::AccessKey",
            "Properties": {
                "UserName": {
                    "Ref": "CfnUser"
                }
            }
        },

        "Ec2Instance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "packages": {
                            "yum": {
                                "gcc-c++": [],
                                "ruby-devel": [],
                                "make": [],
                                "htop": [],
                                "autoconf": [],
                                "automake": [],
                                "rubygems": [],
                                "ruby-devel": [],
                                "libcurl-devel": [],
                                "libxml2-devel": [],
                                "libxslt-devel": [],
                                "curl": [],
                                "git": [],
                                "xfsprogs": []
                            }
                        },
                        "files": {
                            "/var/init/node.json": {
                                "content": {
                                    "run_list": [ "recipe[keboola-syrup]" ],
                                    "papertrail": {
                                        "port": {
                                            "Ref": "PapertrailPort"
                                        }
                                    },
                                    "aws": {
                                        "aws_access_key_id": {
                                            "Ref": "HostKeys"
                                        },
                                        "aws_secret_access_key": {
                                            "Fn::GetAtt": [ "HostKeys", "SecretAccessKey" ]
                                        }

                                    },
                                    "newrelic": {
                                        "license": {
                                            "Ref": "NewRelicLicenseKey"
                                        }
                                    },
                                    "postfix": {
                                        "main": {
                                            "smtp_sasl_password_maps": { "Fn::Join" : ["", [
                                                "static:",
                                                {
                                                    "Ref": "SendgridName"
                                                },
                                                ":",
                                                {
                                                    "Ref": "SendgridPassword"
                                                }
                                            ]]}
                                        }
                                    },
                                    "keboola-syrup": {
                                        "github_token":  {
                                            "Ref": "GithubToken"
                                        },
                                        "gooddata-writer": {
                                            "enable_cron": {
                                                "Ref": "GoodDataWriterEnableCron"
                                            },
                                            "workers_count": {
                                                "Ref": "GoodDataWriterWorkersCount"
                                            }
                                        },
                                        "queue": {
                                            "workers_count": {
                                                "Ref": "QueueWorkersCount"
                                            }
                                        },
                                        "orchestrator": {
                                            "enable_scheduler": {
                                                "Ref": "OrchestratorEnableScheduler"
                                            },
                                            "workers_count": {
                                                "Ref": "OrchestratorWorkersCount"
                                            }
                                        }
                                    }
                                },
                                "mode": "000644",
                                "owner": "root",
                                "group": "wheel"
                            },
                            "/var/init/solo.rb" : {
                                "content" : { "Fn::Join" : ["\n", [
                                    "log_level :info",
                                    "log_location STDOUT",
                                    "cookbook_path [\"/var/chef/berks-cookbooks\"]"
                                ]] },
                                "mode" : "000644",
                                "owner" : "root",
                                "group" : "wheel"
                            },
                            "/var/init/bootstrap.sh": {
                                "content": {
                                    "Fn::Join": ["\n", [
                                        "curl -# -L -k -o /tmp/cookbook-keboola-syrup.tar.gz https://github.com/keboola/cookbook-keboola-syrup/archive/master.tar.gz",
                                        "curl https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chefdk-0.1.0-1.el6.x86_64.rpm > /tmp/chefdk.rpm",
                                        "rpm -i /tmp/chefdk.rpm",
                                        "mkdir -p /var/chef/cookbooks/keboola-syrup",
                                        "tar --strip 1 -C /var/chef/cookbooks/keboola-syrup -xf /tmp/cookbook-keboola-syrup.tar.gz",
                                        "export HOME=/root",
                                        "cd /var/chef/cookbooks/keboola-syrup && /usr/bin/berks vendor /var/chef/berks-cookbooks/"
                                    ]]
                                },
                                "mode": "000644",
                                "owner": "root",
                                "group": "wheel"
                            },
                            "/var/init/storage.sh": {
                                "content": {
                                    "Fn::Join": ["\n", [
                                        "umount /media/ephemeral0/; echo y | mdadm -C /dev/md0 --level=raid0 --raid-devices=2 /dev/xvdb /dev/xvdc ; mkfs.xfs /dev/md0; mount /dev/md0 /media/ephemeral0/",
                                        "mkdir /media/ephemeral0/tmp",
                                        "chmod a+xw /media/ephemeral0/tmp/",
                                        "chmod +t /media/ephemeral0/tmp/",
                                        "mount -o,bind /media/ephemeral0/tmp/ /tmp",
                                        "dd if=/dev/zero of=/media/ephemeral0/swap1.bin count=10000 bs=102400",
                                        "mkswap /media/ephemeral0/swap1.bin",
                                        "swapon /media/ephemeral0/swap1.bin",
                                        "dd if=/dev/zero of=/media/ephemeral0/swap2.bin count=10000 bs=102400",
                                        "mkswap /media/ephemeral0/swap2.bin",
                                        "swapon /media/ephemeral0/swap2.bin",

                                        "mkfs -t xfs /dev/xvdd",
                                        "mkdir /www",
                                        "mount /dev/xvdd /www"
                                    ]]
                                },
                                "mode": "000644",
                                "owner": "root",
                                "group": "wheel"
                            }
                        }
                    }
                }
            },
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [ "AWSRegionArch2AMI", {
                        "Ref": "AWS::Region"
                    },
                        {
                            "Fn::FindInMap": [ "AWSInstanceType2Arch", {
                                "Ref": "InstanceType"
                            }, "Arch" ]
                        } ]
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs" : {
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "DeviceName":"/dev/sdb",
                        "VirtualName" : "ephemeral0"
                    },
                    {
                        "DeviceName": "/dev/sdc",
                        "VirtualName" : "ephemeral1"
                    },
                    {
                        "DeviceName": "/dev/sdd",
                        "Ebs" : {
                            "VolumeSize": "100",
                            "VolumeType": "gp2",
                            "DeleteOnTermination": "true"
                        }
                    }
                ],
                "NetworkInterfaces": [
                    {
                        "GroupSet": [
                            {
                                "Ref": "SecurityGroupVpcId"
                            }
                        ],
                        "AssociatePublicIpAddress": "true",
                        "DeviceIndex": "0",
                        "DeleteOnTermination": "true",
                        "SubnetId": { "Fn::FindInMap" : [ "ZoneToSubnet", { "Ref" : "Zone" }, "SubnetId" ]}
                    }
                ],
                "KeyName": {
                    "Ref": "KeyName"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": ["", [
                            "#!/bin/bash\n",
                            "yum update -y aws-cfn-bootstrap\n",

                            "function error_exit\n",
                            "{\n",
                            "  /opt/aws/bin/cfn-signal -e 1 -r \"$1\" '", {
                                "Ref": "WaitHandle"
                            }, "'\n",
                            "  exit 1\n",
                            "}\n",

                            "/opt/aws/bin/cfn-init -s ", {
                                "Ref": "AWS::StackName"
                            }, " -r Ec2Instance ",
                            "         --region ", {
                                "Ref": "AWS::Region"
                            }, " || error_exit 'Failed to initialize Chef Solo'\n",
                            "bash /var/init/storage.sh > /var/init/storage.log 2>&1\n",
                            "bash /var/init/bootstrap.sh > /var/init/bootstrap.log 2>&1\n",
                            "export HOME=/root\n",
                            "chef-solo -j /var/init/node.json --config /var/init/solo.rb --node-name ",
                            {
                                "Ref": "AWS::StackName"
                            },
                            " > /var/init/chef_solo.log 2>&1\n",
                            "/opt/aws/bin/cfn-signal -e $? '", {
                                "Ref": "WaitHandle"
                            }, "'\n"
                        ]]
                    }
                }

            }

        },

        "publicDNS": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneName": "keboola.com.",
                "Comment": "DNS name for instance.",
                "Name": {
                    "Fn::Join": [ "", [
                        {
                            "Ref": "AWS::StackName"
                        },
                        ".keboola.com"
                    ] ]
                },
                "Type": "A",
                "TTL": "900",
                "ResourceRecords": [
                    {
                        "Fn::GetAtt": [ "Ec2Instance", "PublicIp" ]
                    }
                ]
            }
        },

        "publicDNStransformation": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneName": "keboola.com.",
                "Comment": "DNS name for transformations.",
                "Name": {
                    "Fn::Join": [ "", [
                        {
                            "Ref": "AWS::StackName"
                        },
                        "-transformation.keboola.com"
                    ] ]
                },
                "Type": "A",
                "TTL": "900",
                "ResourceRecords": [
                    {
                        "Fn::GetAtt": [ "Ec2Instance", "PublicIp" ]
                    }
                ]
            }
        },

        "WaitHandle": {
            "Type": "AWS::CloudFormation::WaitConditionHandle"
        },

        "WaitCondition": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "DependsOn": "Ec2Instance",
            "Properties": {
                "Handle": {
                    "Ref": "WaitHandle"
                },
                "Timeout": "1800"
            }
        }
    },
    "Outputs": {
        "Instance": {
            "Value": {
                "Fn::GetAtt": [ "Ec2Instance", "PublicDnsName" ]
            },
            "Description": "DNS Name of the newly created EC2 instance"
        }
    }
}
